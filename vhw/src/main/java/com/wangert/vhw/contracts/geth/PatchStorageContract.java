package com.wangert.vhw.contracts.geth;

import com.wangert.vhw.entities.Web3j.PatchStorage;
import org.web3j.abi.datatypes.Bool;
import org.web3j.abi.datatypes.Utf8String;
import org.web3j.abi.datatypes.generated.Uint64;

/**
 * 补丁数据存储合约
 * 基于以太坊的合约方法封装
 *
 * @Author：youxuan
 */

public class PatchStorageContract {

    private static PatchStorageContract patchStorageContract;
    private static PatchStorage patchStorage;

//    //构造函数，初始化
//    public PatchStorageContract() {
//        patchStorage = GethContract.getInstance().getPatchStorage();
//    }

    public static PatchStorageContract getInstance() {
        if (patchStorageContract == null) {
            synchronized (PatchStorageContract.class) {
                if (patchStorageContract == null) {
                    patchStorageContract = new PatchStorageContract();
                    patchStorage = GethContract.getInstance().getPatchStorage();
                }
            }
        }
        return patchStorageContract;
    }

    //判断补丁是否存在
    public boolean patchExisted(String ipfsHash) {

        boolean result = false;

//        //设置合约方法参数
//        FuncParams funcParams = new FuncParams();
//        funcParams.addParams(ipfsHash);
//
//        List<?> objects = filoeanContract.filoean.invokeContract(filoeanContract.accountPrivateJson, "patchExisted(string)", funcParams);
//
//        result = Boolean.valueOf(objects.get(0).toString());

        return result;

    }

    //判断补丁是否审核通过
    public boolean patchPassed(String ipfsHash) {

        boolean result = false;

//        //设置合约方法参数
//        FuncParams funcParams = new FuncParams();
//        funcParams.addParams(ipfsHash);
//
//        List<?> objects = filoeanContract.filoean.invokeContract(filoeanContract.accountPrivateJson, "patchPassed(string)", funcParams);
//
//        result = Boolean.valueOf(objects.get(0).toString());

        return result;

    }

    //添加补丁发布时间，设置审核通过标志
    public boolean addReleaseTime(String ipfsHash, String releaseTime) {

        boolean result = false;

//        //设置合约方法参数
//        FuncParams funcParams = new FuncParams();
//        funcParams.addParams(ipfsHash);
//        funcParams.addParams(releaseTime);
//
//        List<?> objects = filoeanContract.filoean.invokeContract(filoeanContract.accountPrivateJson, "addReleaseTime(string,string)", funcParams);
//
//        result = Boolean.valueOf(objects.get(0).toString());

        return result;

    }

//    //star加一
//    public boolean incStar(String ipfsHash) {
//
//        boolean result = false;
//
//        //设置合约方法参数
//        FuncParams funcParams = new FuncParams();
//        funcParams.addParams(ipfsHash);
//
//        String functionName = "incStar(string)";
//
//        List<?> objects = filoeanContract.filoean.invokeContract(filoeanContract.accountPrivateJson, functionName, funcParams);
//
//        result = Boolean.valueOf(objects.get(0).toString());
//
//        return result;

//    }

    //增加补丁总评分
    public boolean addPatchTotalScore(String ipfsHash, int addScore) {

        //设置合约方法参数
        Utf8String utf8String = new Utf8String(ipfsHash);
        Uint64 uint64 = new Uint64(addScore);

        String result = null;
        try {
            result = patchStorage.addPatchTotalScore(utf8String, uint64).send().getStatus();
        } catch (Exception e) {
            e.printStackTrace();
        }
        assert result != null;
        return result.equals("0x1");

    }

    //增加补丁
    public boolean addPatch(String ipfsHash, String name, String username, String submitTime, String vulnerabilityIpfsHash) {

        //设置合约方法参数
        Utf8String utf8ipfsHash = new Utf8String(ipfsHash);
        Utf8String utf8name = new Utf8String(name);
        Utf8String utf8username = new Utf8String(username);
        Utf8String utf8submitTime = new Utf8String(submitTime);
        Utf8String utf8vulnerabilityIpfsHash = new Utf8String(vulnerabilityIpfsHash);

        String result = null;
        try {
            result = patchStorage.addPatch(utf8ipfsHash, utf8name, utf8username, utf8submitTime, utf8vulnerabilityIpfsHash).send().getStatus();
        } catch (Exception e) {
            e.printStackTrace();
        }
        assert result != null;
        return result.equals("0x1");

    }

//    //获取补丁基本信息
//    public Septet<String, String, String, String, String, Integer, Integer> getBasicInformation(String ipfsHash) {
//
//        //设置合约方法参数
//        FuncParams funcParams = new FuncParams();
//        funcParams.addParams(ipfsHash);
//
//        List<?> objects = filoeanContract.filoean.invokeContract(filoeanContract.accountPrivateJson, "getBasicInformation(string)", funcParams);
//
//        //获取补丁名称、补丁发布者、补丁提交时间、补丁发布时间、对应的漏洞ipfs哈希、star数量、总评分
//        Septet<String, String, String, String, String, Integer, Integer> septet = new Septet<>(
//                //补丁名称
//                objects.get(0).toString(),
//                //补丁发布者
//                objects.get(1).toString(),
//                //补丁提交时间
//                objects.get(2).toString(),
//                //补丁发布时间
//                objects.get(3).toString(),
//                //对应的漏洞ipfs哈希
//                objects.get(4).toString(),
//                //star数量
//                Integer.valueOf(objects.get(5).toString()),
//                //补丁总评分
//                Integer.valueOf(objects.get(6).toString()));
//
//        return septet;
//
//    }

//    //获取补丁名称
//    public String getPatchName(String ipfsHash) {
//
//        String name;
//
//        //设置合约方法参数
//        FuncParams funcParams = new FuncParams();
//        funcParams.addParams(ipfsHash);
//
//        List<?> objects = filoeanContract.filoean.invokeContract(filoeanContract.accountPrivateJson, "getPatchName(string)", funcParams);
//
//        name = objects.get(0).toString();
//
//        return name;
//
//    }

    //获取补丁发布者
//    public String getPatchUsername(String ipfsHash) {
//
//        String name;
//
//        //设置合约方法参数
//        FuncParams funcParams = new FuncParams();
//        funcParams.addParams(ipfsHash);
//
//        List<?> objects = filoeanContract.filoean.invokeContract(filoeanContract.accountPrivateJson, "getPatchUsername(string)", funcParams);
//
//        name = objects.get(0).toString();
//
//        return name;
//
//    }

//    //获取补丁提交时间
//    public String getPatchSubmitTime(String ipfsHash) {
//
//        String name;
//
//        //设置合约方法参数
//        FuncParams funcParams = new FuncParams();
//        funcParams.addParams(ipfsHash);
//
//        List<?> objects = filoeanContract.filoean.invokeContract(filoeanContract.accountPrivateJson, "getPatchSubmitTime(string)", funcParams);
//
//        name = objects.get(0).toString();
//
//        return name;
//
//    }
//
//    //获取补丁发布时间
//    public String getPatchReleaseTime(String ipfsHash) {
//
//        String name;
//
//        //设置合约方法参数
//        FuncParams funcParams = new FuncParams();
//        funcParams.addParams(ipfsHash);
//
//        List<?> objects = filoeanContract.filoean.invokeContract(filoeanContract.accountPrivateJson, "getPatchReleaseTime(string)", funcParams);
//
//        name = objects.get(0).toString();
//
//        return name;
//
//    }

    //获取补丁对应的漏洞ipfs哈希
    public String getVulnerabilityIpfsHash(String ipfsHash) {

        //设置合约方法参数
        Utf8String utf8ipfsHash = new Utf8String(ipfsHash);

        Utf8String result = null;
        try {
            result = patchStorage.getVulnerabilityIpfsHash(utf8ipfsHash).send();
        } catch (Exception e) {
            e.printStackTrace();
        }
        assert result != null;
        return result.getValue();

    }

//    //获取补丁star数
//    public int getPatchStar(String ipfsHash) {
//
//        int starCount;
//
//        //设置合约方法参数
//        FuncParams funcParams = new FuncParams();
//        funcParams.addParams(ipfsHash);
//
//        List<?> objects = filoeanContract.filoean.invokeContract(filoeanContract.accountPrivateJson, "getPatchStar(string)", funcParams);
//
//        starCount = Integer.parseInt(objects.get(0).toString());
//
//        return starCount;
//
//    }

//    //获取补丁总评分
//    public int getPatchTotalScore(String ipfsHash) {
//
//        int starCount;
//
//        //设置合约方法参数
//        FuncParams funcParams = new FuncParams();
//        funcParams.addParams(ipfsHash);
//
//        List<?> objects = filoeanContract.filoean.invokeContract(filoeanContract.accountPrivateJson, "getPatchTotalScore(string)", funcParams);
//
//        starCount = Integer.parseInt(objects.get(0).toString());
//
//        return starCount;
//
//    }

/*
    public static void main(String[] args) {

        PatchStorageContract patchStorageContract = new PatchStorageContract();

        //boolean b = patchStorageContract.addPatch("test", "test", "wangjitao", "2019Test", "test");

        Septet<String, String, String, String, String, Integer, Integer> septet;

        septet = patchStorageContract.getBasicInformation("test");

        System.out.println("name:" + septet.getValue0());
        System.out.println("username:" + septet.getValue1());
        System.out.println("submitTime:" + septet.getValue2());
        System.out.println("releaseTime:" + septet.getValue3());
        System.out.println("vulnerabilityIpfsHash:" + septet.getValue4());
        System.out.println("starCount:" + septet.getValue5());
        System.out.println("totalScore:" + septet.getValue6());

        //System.out.println("result:" + b);

    }
*/
}
